// Generated by purs version 0.15.10
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Apply from "../Control.Apply/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Category from "../Control.Category/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Boolean from "../Data.Boolean/index.js";
import * as Data_Bounded from "../Data.Bounded/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_HeytingAlgebra from "../Data.HeytingAlgebra/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Set from "../Data.Set/index.js";
import * as Data_String_CodePoints from "../Data.String.CodePoints/index.js";
import * as Data_String_Common from "../Data.String.Common/index.js";
import * as Data_Tuple from "../Data.Tuple/index.js";
import * as Foreign_Object from "../Foreign.Object/index.js";
import * as Node_Path from "../Node.Path/index.js";
import * as Spago_Core_Config from "../Spago.Core.Config/index.js";
import * as Spago_Paths from "../Spago.Paths/index.js";
import * as Spago_Psa_Types from "../Spago.Psa.Types/index.js";
var disj = /* #__PURE__ */ Data_HeytingAlgebra.disj(/* #__PURE__ */ Data_HeytingAlgebra.heytingAlgebraFunction(Data_HeytingAlgebra.heytingAlgebraBoolean));
var eq = /* #__PURE__ */ Data_Eq.eq(Data_String_CodePoints.eqCodePoint);
var foldl = /* #__PURE__ */ Data_Foldable.foldl(Data_Foldable.foldableArray);
var identity = /* #__PURE__ */ Control_Category.identity(Control_Category.categoryFn);
var any = /* #__PURE__ */ Data_Foldable.any(Data_Foldable.foldableArray)(Data_HeytingAlgebra.heytingAlgebraBoolean);
var member = /* #__PURE__ */ Data_Set.member(Data_Ord.ordString);
var apply = /* #__PURE__ */ Control_Apply.apply(Data_Maybe.applyMaybe);
var map = /* #__PURE__ */ Data_Functor.map(Data_Maybe.functorMaybe);
var append = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var map1 = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var $$Error = /* #__PURE__ */ (function () {
    function $$Error() {

    };
    $$Error.value = new $$Error();
    return $$Error;
})();
var Warning = /* #__PURE__ */ (function () {
    function Warning() {

    };
    Warning.value = new Warning();
    return Warning;
})();
var trimPosition = function ($copy_lines) {
    return function ($copy_pos) {
        var $tco_var_lines = $copy_lines;
        var $tco_done = false;
        var $tco_result;
        function $tco_loop(lines, pos) {
            var isPunc = disj(function (v) {
                return eq(v)(Data_String_CodePoints.codePointFromChar(" "));
            })(function (v) {
                return eq(v)(Data_String_CodePoints.codePointFromChar(","));
            });
            var trimComment = function (col) {
                return function (l) {
                    var v = Data_String_CodePoints.indexOf("--")(l);
                    if (v instanceof Data_Maybe.Just && v.value0 === 0) {
                        return Data_Maybe.Nothing.value;
                    };
                    if (v instanceof Data_Maybe.Just && v.value0 < (col - 1 | 0)) {
                        return trimCol(v.value0 + 1 | 0)(l);
                    };
                    return new Data_Maybe.Just(col);
                };
            };
            var trimCol = function ($copy_col) {
                return function ($copy_l) {
                    var $tco_var_col = $copy_col;
                    var $tco_done1 = false;
                    var $tco_result;
                    function $tco_loop(col, l) {
                        var v = Data_String_CodePoints.codePointAt(col - 2 | 0)(l);
                        if (v instanceof Data_Maybe.Just && isPunc(v.value0)) {
                            $tco_var_col = col - 1 | 0;
                            $copy_l = l;
                            return;
                        };
                        if (v instanceof Data_Maybe.Just) {
                            $tco_done1 = true;
                            return trimComment(col)(l);
                        };
                        $tco_done1 = true;
                        return Data_Maybe.Nothing.value;
                    };
                    while (!$tco_done1) {
                        $tco_result = $tco_loop($tco_var_col, $copy_l);
                    };
                    return $tco_result;
                };
            };
            var trimPos = function ($copy_v) {
                var $tco_done2 = false;
                var $tco_result;
                function $tco_loop(v) {
                    if (v.col <= 1) {
                        var v1 = Data_Array.index(lines)((v.row - pos.startLine | 0) - 1 | 0);
                        if (v1 instanceof Data_Maybe.Just) {
                            $copy_v = {
                                row: v.row - 1 | 0,
                                col: Data_String_CodePoints.length(v1.value0) + 1 | 0
                            };
                            return;
                        };
                        $tco_done2 = true;
                        return Data_Maybe.Nothing.value;
                    };
                    if (Data_Boolean.otherwise) {
                        var v1 = Data_Array.index(lines)(v.row - pos.startLine | 0);
                        if (v1 instanceof Data_Maybe.Just) {
                            var v2 = trimCol(v.col)(v1.value0);
                            if (v2 instanceof Data_Maybe.Just) {
                                $tco_done2 = true;
                                return new Data_Maybe.Just({
                                    row: v.row,
                                    col: v2.value0
                                });
                            };
                            if (v2 instanceof Data_Maybe.Nothing) {
                                $copy_v = {
                                    row: v.row,
                                    col: 1
                                };
                                return;
                            };
                            throw new Error("Failed pattern match at Spago.Psa.Output (line 232, column 13 - line 234, column 49): " + [ v2.constructor.name ]);
                        };
                        $tco_done2 = true;
                        return Data_Maybe.Nothing.value;
                    };
                    throw new Error("Failed pattern match at Spago.Psa.Output (line 223, column 3 - line 236, column 23): " + [ v.constructor.name ]);
                };
                while (!$tco_done2) {
                    $tco_result = $tco_loop($copy_v);
                };
                return $tco_result;
            };
            if (lines.length === 0) {
                $tco_done = true;
                return {
                    startLine: pos.startLine,
                    startColumn: pos.startColumn,
                    endLine: pos.startLine,
                    endColumn: pos.startColumn
                };
            };
            if (lines.length === 1) {
                var v = trimCol(pos.endColumn)(lines[0]);
                if (v instanceof Data_Maybe.Just) {
                    $tco_done = true;
                    return {
                        startLine: pos.startLine,
                        startColumn: pos.startColumn,
                        endLine: pos.startLine,
                        endColumn: v.value0
                    };
                };
                if (v instanceof Data_Maybe.Nothing) {
                    $tco_done = true;
                    return {
                        startLine: pos.startLine,
                        startColumn: pos.startColumn,
                        endLine: pos.startLine,
                        endColumn: pos.startColumn
                    };
                };
                throw new Error("Failed pattern match at Spago.Psa.Output (line 211, column 7 - line 213, column 80): " + [ v.constructor.name ]);
            };
            var v = trimPos({
                row: pos.endLine,
                col: pos.endColumn
            });
            if (v instanceof Data_Maybe.Just) {
                $tco_done = true;
                return {
                    startLine: pos.startLine,
                    startColumn: pos.startColumn,
                    endLine: v.value0.row,
                    endColumn: v.value0.col
                };
            };
            if (v instanceof Data_Maybe.Nothing) {
                $tco_var_lines = [  ];
                $copy_pos = pos;
                return;
            };
            throw new Error("Failed pattern match at Spago.Psa.Output (line 216, column 7 - line 218, column 39): " + [ v.constructor.name ]);
        };
        while (!$tco_done) {
            $tco_result = $tco_loop($tco_var_lines, $copy_pos);
        };
        return $tco_result;
    };
};
var trimMessage = /* #__PURE__ */ (function () {
    var dedent = function (v) {
        return function (l) {
            if (l === "") {
                return {
                    lines: Data_Array.snoc(v.lines)(l),
                    indent: v.indent
                };
            };
            if (Data_Boolean.otherwise) {
                var indent$prime = Data_String_CodePoints.length(Data_String_CodePoints.takeWhile(function (v1) {
                    return eq(v1)(Data_String_CodePoints.codePointFromChar(" "));
                })(l));
                var $95 = indent$prime < v.indent;
                if ($95) {
                    return {
                        lines: Data_Array.snoc(v.lines)(Data_String_CodePoints.drop(indent$prime)(l)),
                        indent: indent$prime
                    };
                };
                return {
                    lines: Data_Array.snoc(v.lines)(Data_String_CodePoints.drop(v.indent)(l)),
                    indent: v.indent
                };
            };
            throw new Error("Failed pattern match at Spago.Psa.Output (line 265, column 3 - line 272, column 71): " + [ v.constructor.name, l.constructor.name ]);
        };
    };
    var collapse = function (lines) {
        return function (l) {
            var v = Data_Array.last(lines);
            if (v instanceof Data_Maybe.Just && (v.value0 === "" && l === "")) {
                return lines;
            };
            return Data_Array.snoc(lines)(l);
        };
    };
    var $141 = Data_String_Common.joinWith("\x0a");
    var $142 = foldl(collapse)([  ]);
    var $143 = foldl(dedent)({
        lines: [  ],
        indent: Data_Bounded.top(Data_Bounded.boundedInt)
    });
    var $144 = Data_String_Common.split("\x0a");
    return function ($145) {
        return Data_String_Common.trim($141($142((function (v) {
            return v.lines;
        })($143($144($145))))));
    };
})();
var onTag = function (v) {
    return function (v1) {
        return function (v2) {
            return function (v3) {
                if (v2 instanceof $$Error) {
                    return v(v3);
                };
                if (v2 instanceof Warning) {
                    return v1(v3);
                };
                throw new Error("Failed pattern match at Spago.Psa.Output (line 180, column 1 - line 180, column 64): " + [ v.constructor.name, v1.constructor.name, v2.constructor.name, v3.constructor.name ]);
            };
        };
    };
};
var onPath = function (v) {
    return function (v1) {
        return function (v2) {
            return function (v3) {
                if (v2 instanceof Spago_Psa_Types.Src) {
                    return v(v3);
                };
                if (v2 instanceof Spago_Psa_Types.Lib) {
                    return v1(v3);
                };
                return v3;
            };
        };
    };
};
var updateStats = function (tag) {
    return function (path) {
        return function (code) {
            return function (printed) {
                return function (s) {
                    var bump = function (v) {
                        return new Data_Tuple.Tuple((function () {
                            if (printed) {
                                return v.value0 + 1 | 0;
                            };
                            return v.value0;
                        })(), v.value1 + 1 | 0);
                    };
                    var alterStat = function (v) {
                        if (v instanceof Data_Maybe.Nothing) {
                            return new Data_Maybe.Just(bump(new Data_Tuple.Tuple(0, 0)));
                        };
                        if (v instanceof Data_Maybe.Just) {
                            return new Data_Maybe.Just(bump(v.value0));
                        };
                        throw new Error("Failed pattern match at Spago.Psa.Output (line 148, column 3 - line 148, column 46): " + [ v.constructor.name ]);
                    };
                    var bumpCode = Foreign_Object.alter(alterStat)(code);
                    return {
                        allWarnings: onTag(identity)(bumpCode)(tag)(s.allWarnings),
                        allErrors: onTag(bumpCode)(identity)(tag)(s.allErrors),
                        srcWarnings: onTag(identity)(onPath(bumpCode)(identity)(path))(tag)(s.srcWarnings),
                        srcErrors: onTag(onPath(bumpCode)(identity)(path))(identity)(tag)(s.srcErrors),
                        libWarnings: onTag(identity)(onPath(identity)(bumpCode)(path))(tag)(s.libWarnings),
                        libErrors: onTag(onPath(identity)(bumpCode)(path))(identity)(tag)(s.libErrors)
                    };
                };
            };
        };
    };
};
var isSrc = function (v) {
    if (v instanceof Spago_Psa_Types.Src) {
        return true;
    };
    return false;
};
var isLib = function (v) {
    if (v instanceof Spago_Psa_Types.Lib) {
        return true;
    };
    return false;
};
var initialStats = {
    allWarnings: Foreign_Object.empty,
    allErrors: Foreign_Object.empty,
    srcWarnings: Foreign_Object.empty,
    srcErrors: Foreign_Object.empty,
    libWarnings: Foreign_Object.empty,
    libErrors: Foreign_Object.empty
};
var errorPath = function (libDirs) {
    return function (path) {
        return function ($$short) {
            var startsWith = function (s$prime) {
                return function (s) {
                    var v = Data_String_CodePoints.indexOf(s)(s$prime);
                    if (v instanceof Data_Maybe.Just && v.value0 === 0) {
                        return true;
                    };
                    return false;
                };
            };
            var $122 = any(function (dir) {
                return startsWith(path)(dir);
            })(libDirs);
            if ($122) {
                return new Spago_Psa_Types.Lib($$short);
            };
            return new Spago_Psa_Types.Src($$short);
        };
    };
};
var censorSrc = function (v) {
    if (v instanceof Spago_Core_Config.CensorAllWarnings) {
        return true;
    };
    if (v instanceof Spago_Core_Config.CensorProjectWarnings) {
        return true;
    };
    return false;
};
var censorLib = function (v) {
    if (v instanceof Spago_Core_Config.CensorAllWarnings) {
        return true;
    };
    if (v instanceof Spago_Core_Config.CensorProjectWarnings) {
        return true;
    };
    return false;
};
var shouldShowError = function (v) {
    return function (v1) {
        return function (v2) {
            return function (v3) {
                if (v1 instanceof $$Error) {
                    return true;
                };
                return !(censorSrc(v.censorBuildWarnings) && isSrc(v2) || censorLib(v.censorBuildWarnings) && isLib(v2)) && ((Data_Set.isEmpty(v.filterCodes) || member(v3)(v.filterCodes)) && (Data_Set.isEmpty(v.censorCodes) || !member(v3)(v.censorCodes)));
            };
        };
    };
};
var annotatedError = function (path) {
    return function (lines) {
        return function (error) {
            var position = apply(map(trimPosition)(lines))(error.position);
            var source = apply(map(function (p) {
                return Data_Array.take((p.endLine - p.startLine | 0) + 1 | 0);
            })(position))(lines);
            var message = trimMessage(error.message);
            return {
                path: path,
                position: position,
                message: message,
                source: source,
                error: error
            };
        };
    };
};
var buildOutput = function (dictMonad) {
    var pure = Control_Applicative.pure(dictMonad.Applicative0());
    var bind = Control_Bind.bind(dictMonad.Bind1());
    var foldM = Data_Array.foldM(dictMonad);
    return function (loadLines) {
        return function (options) {
            return function (result) {
                var pathOf = function (x) {
                    if (x.filename instanceof Data_Maybe.Just && x.filename.value0 !== "") {
                        var path = (function () {
                            if (Node_Path.isAbsolute(x.filename.value0)) {
                                return x.filename.value0;
                            };
                            if (Data_Boolean.otherwise) {
                                return Node_Path.concat([ Spago_Paths.cwd, x.filename.value0 ]);
                            };
                            throw new Error("Failed pattern match at Spago.Psa.Output (line 94, column 11 - line 96, column 55): " + [  ]);
                        })();
                        return new Data_Tuple.Tuple(errorPath(options.libraryDirs)(path)(x.filename.value0), x);
                    };
                    return new Data_Tuple.Tuple(Spago_Psa_Types.Unknown.value, x);
                };
                var onError = function (tag) {
                    return function (state) {
                        return function (v) {
                            var update = function (log) {
                                var printed = !Data_Array["null"](log);
                                var tag$prime = (function () {
                                    var $137 = printed && (options.strict && isSrc(v.value0));
                                    if ($137) {
                                        return $$Error.value;
                                    };
                                    return tag;
                                })();
                                var stats = updateStats(tag$prime)(v.value0)(v.value1.errorCode)(printed)(state.stats);
                                return pure(onTag(function (v1) {
                                    return {
                                        stats: stats,
                                        errors: append(state.errors)(log),
                                        warnings: v1.warnings
                                    };
                                })(function (v1) {
                                    return {
                                        stats: stats,
                                        errors: v1.errors,
                                        warnings: append(state.warnings)(log)
                                    };
                                })(tag$prime)(state));
                            };
                            var $138 = shouldShowError(options)(tag)(v.value0)(v.value1.errorCode);
                            if ($138) {
                                return bind(Data_Maybe.fromMaybe(pure(Data_Maybe.Nothing.value))(apply(map(loadLines)(v.value1.filename))(v.value1.position)))(function (source) {
                                    return update([ annotatedError(v.value0)(source)(v.value1) ]);
                                });
                            };
                            return update([  ]);
                        };
                    };
                };
                var result$prime = {
                    warnings: map1(pathOf)(result.warnings),
                    errors: map1(pathOf)(result.errors)
                };
                var initialState = {
                    warnings: [  ],
                    errors: [  ],
                    stats: initialStats
                };
                return bind(foldM(onError(Warning.value))(initialState)(result$prime.warnings))(function (state) {
                    return bind(foldM(onError($$Error.value))(state)(result$prime.errors))(function (state$prime) {
                        return pure({
                            warnings: Data_Array.sortBy(Spago_Psa_Types.compareByLocation)(state$prime.warnings),
                            errors: Data_Array.sortBy(Spago_Psa_Types.compareByLocation)(state$prime.errors),
                            stats: state$prime.stats
                        });
                    });
                });
            };
        };
    };
};
export {
    buildOutput,
    annotatedError,
    trimPosition,
    trimMessage
};
//# sourceMappingURL=index.js.map
